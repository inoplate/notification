{"version":3,"sources":["list.coffee"],"names":[],"mappings":"AAAA;AAAA,MAAA,gBAAA;IAAA;;EAAM;IACW,0BAAC,QAAD,EAAY,OAAZ;AACT,UAAA;MADU,IAAC,CAAA,WAAD;;MACV,IAAC,CAAA,OAAD,GAAW,OAAO,CAAC,MAAR,IAAkB,IAAC,CAAA,kBAAD,CAAA;MAC7B,IAAC,CAAA,QAAD,GAAY,OAAO,CAAC,QAAR,IAAoB;MAChC,IAAC,CAAA,OAAD,GAAW,OAAO,CAAC,OAAR,IAAmB;MAC9B,IAAC,CAAA,OAAD,GAAW,OAAO,CAAC,MAAR,IAAkB;MAC7B,IAAC,CAAA,MAAD,GAAU,OAAO,CAAC,MAAR,IAAkB;MAC5B,IAAC,CAAA,UAAD,GAAc,OAAO,CAAC,UAAR,IAAsB;MACpC,IAAC,CAAA,WAAD,GAAe,CAAA,CAAE,IAAC,CAAA,UAAH,EAAe,IAAC,CAAA,QAAhB;MACf,IAAC,CAAA,QAAD,GAAY,CAAA,CAAE,IAAC,CAAA,OAAH,EAAY,IAAC,CAAA,QAAb;MACZ,IAAC,CAAA,aAAD,GAAiB,OAAO,CAAC;MACzB,YAAA,GAAe,IAAC,CAAA,QAAQ,CAAC,IAAV,CAAe,WAAf;MAEf,CAAA,CAAE,MAAF,CACI,CAAC,MADL,CACY,CAAA,SAAA,KAAA;eAAA,SAAA;iBACJ,KAAC,CAAA,eAAD,CAAA;QADI;MAAA,CAAA,CAAA,CAAA,IAAA,CADZ;MAIA,OAAA,GACI;QAAA,sBAAA,EAAwB,IAAxB;QACA,YAAA,EAAc,EADd;QAEA,YAAA,EAAc,IAFd;;MAIA,IAAA,EAAE,CAAC,OAAH,CAAW,YAAX,EAAyB,IAAC,CAAA,eAA1B,EAA2C,IAAC,CAAA,YAA5C,EAA0D,OAA1D;IArBK;;+BAuBb,SAAA,GAAW,SAAA;AACP,aAAO,IAAC,CAAA;IADD;;+BAGX,eAAA,GAAiB,SAAA;AACb,UAAA;MAAA,OAAO,CAAC,GAAR,CAAY,IAAC,CAAA,WAAW,CAAC,EAAb,CAAgB,kBAAhB,CAAZ;MACA,IAAG,IAAC,CAAA,WAAW,CAAC,EAAb,CAAgB,kBAAhB,CAAA,IAAuC,CAAC,IAAC,CAAA,WAAW,CAAC,IAAb,CAAkB,SAAlB,CAA3C;QACI,GAAA,GAAM,CAAA,CAAE,GAAF,EAAO,IAAC,CAAA,WAAR,CACE,CAAC,IADH,CACQ,MADR;eAGN,IAAC,CAAA,UAAD,CAAY,GAAZ,EAJJ;;IAFa;;+BAQjB,eAAA,GAAiB,SAAC,OAAD;MACb,OAAO,CAAC,IAAR,CAAa,WAAb;aACA,OAAO,CAAC,SAAR,CAAkB,cAAlB,EAAkC,CAAA,SAAA,KAAA;eAAA,SAAC,KAAD,EAAQ,IAAR;iBAC9B,KAAC,CAAA,QAAQ,CAAC,OAAV,CAAkB,KAAI,CAAC,aAAL,CAAmB,IAAI,CAAC,YAAxB,CAAlB;QAD8B;MAAA,CAAA,CAAA,CAAA,IAAA,CAAlC;IAFa;;+BAKjB,YAAA,GAAc,SAAA;aACV,OAAO,CAAC,IAAR,CAAa,6BAAb;IADU;;+BAGd,UAAA,GAAY,SAAC,GAAD,EAAM,QAAN,EAAqB,QAArB;AACR,UAAA;;QADc,WAAW;;MACzB,QAAA,GAAW,IAAI,CAAC,mBAAL,CAAyB,QAAzB;MACX,GAAA,GAAM,EAAA,GAAG,GAAH,GAAS;MACf,KAAA,GAAQ;MACR,IAAC,CAAA,QAAQ,CAAC,OAAV,CAAkB,yCAAlB;MACA,IAAC,CAAA,WAAW,CAAC,IAAb,CAAkB,SAAlB,EAA6B,IAA7B;aAEA,CAAC,CAAC,GAAF,CAAM,GAAN,EAAW,CAAA,SAAA,KAAA;eAAA,SAAC,MAAD;AACP,cAAA;UAAA,IAAG,OAAO,QAAP,KAAmB,UAAtB;YACI,QAAQ,CAAC,KAAT,CAAe,KAAf,EADJ;;AAGA;AAAA,eAAA,qCAAA;;YAAA,KAAC,CAAA,QAAQ,CAAC,MAAV,CAAiB,KAAI,CAAC,aAAL,CAAmB,IAAnB,CAAjB;AAAA;UAEA,IAAG,MAAM,CAAC,aAAa,CAAC,aAAxB;YACI,CAAA,CAAE,GAAF,EAAO,KAAC,CAAA,WAAR,CACI,CAAC,IADL,CACU,MADV,EACkB,MAAM,CAAC,aAAa,CAAC,aADvC;YAGA,KAAC,CAAA,WACG,CAAC,IADL,CACU,SADV,EACqB,KADrB;YAGA,CAAA,CAAE,KAAC,CAAA,OAAH,EAAY,KAAC,CAAA,QAAb,CACI,CAAC,QADL,CACc,MADd;YAGA,KAAC,CAAA,eAAD,CAAA,EAVJ;WAAA,MAAA;YAYI,KAAC,CAAA,WACG,CAAC,QADL,CACc,MADd;YAGA,CAAA,CAAE,KAAC,CAAA,OAAH,EAAY,KAAC,CAAA,QAAb,CACI,CAAC,WADL,CACiB,MADjB,EAfJ;;iBAkBA,KAAC,CAAA,QAAQ,CAAC,OAAV,CAAkB,wCAAlB;QAxBO;MAAA,CAAA,CAAA,CAAA,IAAA,CAAX,EA0BI,MA1BJ;IAPQ;;+BAmCZ,mBAAA,GAAqB,SAAC,QAAD;AACjB,UAAA;MAAA,cAAA,GAAiB,IAAC,CAAA;MAElB,IAAG,OAAO,QAAP,KAAmB,UAAtB;QACI,QAAA,GAAW,QAAQ,CAAC,KAAT,CAAe,IAAf,EADf;;MAGA,IAAG,OAAO,IAAC,CAAA,QAAR,KAAoB,UAAvB;QACI,cAAA,GAAiB,IAAC,CAAA,QAAQ,CAAC,KAAV,CAAgB,IAAhB,EADrB;;MAGA,QAAA,GAAW,CAAC,CAAC,MAAF,CAAS,cAAT,EAAyB,QAAzB,EAAmC,IAAnC;MACX,QAAA,GAAW,IAAI,CAAC,kBAAL,CAAwB,QAAxB;aAEX;IAZiB;;+BAerB,kBAAA,GAAoB,SAAA;aACf,CAAA,CAAE,qHAAF;IADe;;+BAMpB,aAAA,GAAe,SAAC,IAAD;AACX,UAAA;MAAA,OAAA,GAAU,IAAC,CAAA,SAAD,CAAA,CAAY,CAAC,KAAb,CAAA;MAEV,IAAG,OAAA,YAAmB,CAAtB;QACI,QAAA,GAAW,MAAA,CAAO,IAAI,CAAC,UAAZ;QACX,GAAA,GAAM,MAAA,CAAO,IAAI,CAAC,GAAL,CAAA,CAAP;QAEN,OAAA,GAAU,GAAG,CAAC,IAAJ,CAAS,QAAT,EAAmB,MAAnB;QAEV,IAAG,OAAA,GAAU,CAAb;UACI,QAAA,GAAW,MAAA,CAAO,IAAI,CAAC,UAAZ,CACC,CAAC,MADF,CACS,IADT,EADf;SAAA,MAAA;UAII,QAAA,GAAW,MAAA,CAAO,IAAI,CAAC,UAAZ,CACC,CAAC,OADF,CAAA,EAJf;;QAOA,CAAA,CAAE,UAAF,EAAc,OAAd,CACI,CAAC,IADL,CACU,IAAI,CAAC,OADf;QAGA,CAAA,CAAE,WAAF,EAAe,OAAf,CACI,CAAC,IADL,CACU,QADV;QAGA,OAAO,CAAC,IAAR,CAAa,IAAb,EAAmB,IAAI,CAAC,EAAxB;QACA,OAAO,CAAC,IAAR,CAAa,QAAb,EAAuB,IAAI,CAAC,MAA5B,EApBJ;OAAA,MAsBK,IAAG,OAAO,OAAP,KAAkB,UAArB;QACD,OAAA,GAAU,OAAO,CAAC,KAAR,CAAc,IAAd,EAAoB,CAAC,IAAD,CAApB,EADT;;aAGL;IA5BW;;+BA8Bf,kBAAA,GAAoB,SAAC,QAAD;AAChB,UAAA;MAAA,MAAA,GAAS;AAET,WAAA,aAAA;;QACI,MAAA,GAAY,MAAD,GAAQ,GAAR,GAAW,CAAX,GAAa,GAAb,GAAgB;AAD/B;aAGA;IANgB;;;;;;EAWxB,CAAC,CAAC,EAAE,CAAC,gBAAL,GAAwB,SAAC,MAAD;AACpB,QAAA;IAAA,IAAA,GAAO;IACP,QAAA,GACI;MAAA,MAAA,EAAQ,OAAR;;IAEJ,IAAI,CAAC,IAAL,CAAU,SAAA;AACN,UAAA;MAAA,KAAA,GAAQ,CAAA,CAAE,IAAF;MACR,IAAA,GAAO,KAAK,CAAC,IAAN,CAAW,mBAAX;MACP,OAAA,GAAU,CAAC,CAAC,MAAF,CAAS,EAAT,EAAa,QAAb,EAAuB,KAAK,CAAC,IAAN,CAAA,CAAvB,EAAqC,OAAO,MAAP,KAAiB,QAAjB,IAA6B,MAAlE;MACV,IAAG,CAAC,IAAJ;QACI,KAAK,CAAC,IAAN,CAAW,mBAAX,EAAgC,CAAC,IAAA,GAAW,IAAA,gBAAA,CAAiB,KAAjB,EAAwB,OAAxB,CAAZ,CAAhC,EADJ;;MAGA,IAAG,OAAO,MAAP,KAAiB,QAApB;QACI,UAAA,GAAa;AAEb,aAAA,SAAA;;UACI,IAAG,CAAA,GAAI,CAAP;YACI,UAAU,CAAC,IAAX,CAAgB,CAAhB,EADJ;;AADJ;eAIA,IAAK,CAAA,MAAA,CAAO,CAAC,KAAb,CAAmB,IAAnB,EAAyB,UAAzB,EAPJ;;IAPM,CAAV;WAgBA;EArBoB;AA5IxB","file":"list.js","sourcesContent":["class NotificationList\n    constructor: (@$element, options) ->\n        @$markup = options.markup || @__getDefaultMarkup()\n        @payloads = options.payloads || {}\n        @endInfo = options.endInfo || '.end-info'\n        @wrapper = options.holder || 'ul'\n        @holder = options.holder || 'li'\n        @nextLoader = options.nextLoader || '.loader'\n        @$nextLoader = $ @nextLoader, @$element\n        @$wrapper = $ @wrapper, @$element\n        @markAsReadUrl = options.markAsReadUrl\n        websocketUrl = @$element.data 'websocket'\n\n        $ window\n            .scroll () =>\n                @checkPagination()\n\n        options = \n            'skipSubprotocolCheck': true\n            'maxRetries': 60\n            'retryDelay': 2000\n\n        new ab.connect websocketUrl, @__onWsConnected, @__onWsClosed, options\n\n    getMarkup: () ->\n        return @$markup\n\n    checkPagination: () ->\n        console.log(@$nextLoader.is(':within-viewport'));\n        if @$nextLoader.is(':within-viewport') && !@$nextLoader.data('loading')\n            url = $ 'a', @$nextLoader\n                    .prop 'href'\n\n            @__loadMore url\n\n    __onWsConnected: (session) =>\n        console.info 'connected';\n        session.subscribe 'notification', (topic, data) =>\n            @$wrapper.prepend this.__buildMarkup data.notification\n\n    __onWsClosed: () ->\n        console.warn 'WebSocket connection closed'\n\n    __loadMore: (url, payloads = {}, callback) ->\n        payloads = this.__normalizePayloads payloads\n        url = \"#{url}#{payloads}\"\n        items = []\n        @$element.trigger \"notifications.notification.list.loading\"\n        @$nextLoader.data 'loading', true\n\n        $.get url, (result) =>\n            if typeof callback == 'function'\n                callback.apply this\n\n            @$wrapper.append this.__buildMarkup item for item in result.notifications.data\n\n            if result.notifications.next_page_url\n                $ 'a', @$nextLoader\n                    .prop 'href', result.notifications.next_page_url\n\n                @$nextLoader\n                    .data 'loading', false\n\n                $ @endInfo, @$element\n                    .addClass 'hide'\n\n                @checkPagination()\n            else\n                @$nextLoader\n                    .addClass 'hide'\n\n                $ @endInfo, @$element\n                    .removeClass 'hide'\n\n            @$element.trigger \"notifications.notification.list.loaded\"\n        ,\n            'json'\n\n    __normalizePayloads: (payloads) ->\n        globalPayloads = @payloads\n\n        if typeof payloads == 'function'\n            payloads = payloads.apply this\n\n        if typeof @payloads == 'function'\n            globalPayloads = @payloads.apply this\n\n        payloads = $.extend globalPayloads, payloads, true\n        payloads = this.__stringifyPayload payloads\n\n        payloads\n\n\n    __getDefaultMarkup: () ->\n         $ \"<li class=\\\"clearfix\\\">\n                <span class=\\\"pull-left message\\\"></span>\n                <span class=\\\"pull-right datetime\\\"></span>\n            </li>\"\n\n    __buildMarkup: (data) ->\n        $markup = @getMarkup().clone()\n\n        if $markup instanceof $\n            datetime = moment(data.created_at);\n            now = moment(Date.now());\n\n            dayDiff = now.diff datetime, 'days';\n\n            if(dayDiff > 1) \n                datetime = moment data.created_at\n                            .format 'LL'\n            else\n                datetime = moment data.created_at\n                            .fromNow()\n\n            $ '.message', $markup\n                .text data.message\n\n            $ '.datetime', $markup\n                .text datetime\n\n            $markup.data 'id', data.id\n            $markup.data 'viewed', data.viewed\n\n        else if typeof $markup == 'function'\n            $markup = $markup.apply this, [data]\n\n        $markup    \n\n    __stringifyPayload: (payloads) ->\n        string = \"\"\n\n        for k,v of payloads\n            string = \"#{string}&#{k}=#{v}\"\n\n        string\n\n# PLUGIN DEFINITION\n# ============================\n\n$.fn.notificationList = (option) ->\n    args = arguments\n    defaults = \n        height: \"450px\"\n\n    this.each () ->\n        $this = $ this\n        data = $this.data('notification.list')\n        options = $.extend {}, defaults, $this.data(), typeof option == 'object' && option\n        if !data \n            $this.data 'notification.list', (data = new NotificationList $this, options)\n\n        if typeof option == 'string'\n            argsToSent = []\n\n            for k,v of args\n                if k > 0\n                    argsToSent.push v\n\n            data[option].apply(data, argsToSent)\n\n    this"],"sourceRoot":"/source/"}